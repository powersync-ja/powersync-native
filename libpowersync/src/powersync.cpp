#include "powersync.h"

namespace powersync::internal {
    // Not generated by cbindgen
    struct InnerPowerSyncState;
}

#include "bindings.h"

namespace powersync {
    static void handle_result(internal::PowerSyncResultCode rc) {
        if (rc != internal::PowerSyncResultCode::OK) {
            auto msg = internal::powersync_last_error_desc();
            throw Exception(1, msg);
        }
    }

    const char * Exception::what() const noexcept {
        if (this->msg) {
            return this->msg;
        }

        return "Unknown error";
    }

    Exception::~Exception() noexcept {
        if (this->msg) {
            internal::powersync_free_str(this->msg);
        }
    }

    Database Database::in_memory(Schema schema) {
        internal::RawPowerSyncDatabase db{};
        handle_result(internal::powersync_db_in_memory(&db));

        return Database(db.db);
    }

    LeasedConnection Database::reader() const {
        internal::ConnectionLeaseResult result{};

        auto raw = static_cast<internal::InnerPowerSyncState*>(this->rust_db);
        handle_result(internal::powersync_db_reader(raw, &result));
        return {result.sqlite3, result.lease};
    }

    LeasedConnection Database::writer() const {
        internal::ConnectionLeaseResult result{};

        auto raw = static_cast<internal::InnerPowerSyncState*>(this->rust_db);
        handle_result(internal::powersync_db_writer(raw, &result));
        return {result.sqlite3, result.lease};
    }

    LeasedConnection::~LeasedConnection() {
        internal::powersync_db_return_lease(static_cast<internal::RawConnectionLease*>(this->raw_lease));
    }

    LeasedConnection::operator sqlite3 *() const {
        return this->db;
    }
}

